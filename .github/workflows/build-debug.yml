name: Android CI - Debug Build

# 触发器
on:
  # 手动触发
  workflow_dispatch:
    inputs:
      build_name:
        description: '构建名称 (例如: debug-build-001)'
        required: true
        type: string
        default: 'debug-build'
  
  # 推送到主分支时自动构建
  push:
    branches: [ main, master ]
  
  # PR 时构建
  pull_request:
    branches: [ main, master ]

jobs:
  build-debug:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. 设置 JDK
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      
      # 3. 编译 debug APK（不需要签名）
      - name: Build Debug APK
        run: |
          echo "开始编译 debug 版本..."
          ./gradlew assembleDebug
          echo "编译完成！"
      
      # 4. 查找生成的 APK 文件
      - name: Find APK files
        id: find-apk
        run: |
          # 查找所有 APK 文件
          APK_FILES=$(find . -name "*.apk" -type f | grep -v ".gradle" || true)
          if [ -n "$APK_FILES" ]; then
            echo "找到 APK 文件:"
            echo "$APK_FILES"
            # 将文件列表存储为输出
            echo "apk_list<<EOF" >> $GITHUB_OUTPUT
            echo "$APK_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "未找到 APK 文件"
            echo "apk_list=" >> $GITHUB_OUTPUT
          fi
      
      # 5. 显示 APK 信息
      - name: Show APK info
        if: steps.find-apk.outputs.apk_list != ''
        run: |
          echo "=== 生成的 APK 文件 ==="
          for apk in ${{ steps.find-apk.outputs.apk_list }}; do
            echo "文件: $apk"
            echo "大小: $(ls -lh "$apk" | awk '{print $5}')"
            echo ""
          done
      
      # 6. 上传 APK 作为产物
      - name: Upload Debug APK
        if: steps.find-apk.outputs.apk_list != ''
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-${{ github.sha }}-${{ github.run_id }}
          path: ${{ steps.find-apk.outputs.apk_list }}
          retention-days: 30
          
      # 7. 上传编译日志（可选）
      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.sha }}
          path: |
            **/build/reports/**
            **/build/outputs/logs/**
          retention-days: 7
